<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <!-- NUCLEAR OPTION: COMPLETE ERROR SUPPRESSION -->
    <script>
        // IMMEDIATELY override console.error to suppress ethereum errors
        (function() {
            const originalError = console.error;
            console.error = function(...args) {
                const message = args.join(' ');
                if (message.includes('ethereum') ||
                    message.includes('Cannot redefine property') ||
                    message.includes('inpage.js')) {
                    return; // Completely suppress
                }
                return originalError.apply(console, args);
            };

            // Override window.onerror IMMEDIATELY
            window.onerror = function(message, source, lineno, colno, error) {
                if (message && (
                    message.includes('ethereum') ||
                    message.includes('Cannot redefine property') ||
                    source && source.includes('inpage.js')
                )) {
                    return true; // Suppress completely
                }
                return false;
            };

            // Override addEventListener to catch errors before they bubble
            const originalAddEventListener = window.addEventListener;
            window.addEventListener = function(type, listener, options) {
                if (type === 'error') {
                    const wrappedListener = function(event) {
                        if (event.message && (
                            event.message.includes('ethereum') ||
                            event.message.includes('Cannot redefine property') ||
                            event.filename && event.filename.includes('inpage.js')
                        )) {
                            event.preventDefault();
                            event.stopPropagation();
                            event.stopImmediatePropagation();
                            return false;
                        }
                        return listener.call(this, event);
                    };
                    return originalAddEventListener.call(this, type, wrappedListener, options);
                }
                return originalAddEventListener.call(this, type, listener, options);
            };

            console.log('🔇 Nuclear error suppression activated');
        })();
    </script>

    <!-- ULTIMATE ERROR SUPPRESSION - MUST BE FIRST -->
    <script>
        (function() {
            // AGGRESSIVE ETHEREUM PROPERTY CONFLICT PREVENTION
            try {
                // Override Object.defineProperty IMMEDIATELY before any extensions load
                const originalDefineProperty = Object.defineProperty;
                const originalDefineProperties = Object.defineProperties;

                // Track ethereum property attempts
                let ethereumAttempts = 0;

                // Override defineProperty
                Object.defineProperty = function(obj, prop, descriptor) {
                    if (obj === window && prop === 'ethereum') {
                        ethereumAttempts++;
                        console.log(`🔧 Ethereum property definition attempt #${ethereumAttempts} - allowing with configurable: true`);

                        // Force it to be configurable and writable
                        descriptor = {
                            ...descriptor,
                            configurable: true,
                            writable: true
                        };
                    }

                    try {
                        return originalDefineProperty.call(this, obj, prop, descriptor);
                    } catch (error) {
                        if (prop === 'ethereum' && error.message.includes('Cannot redefine property')) {
                            console.log('🔧 Ethereum redefinition blocked - deleting and retrying');
                            try {
                                delete obj[prop];
                                return originalDefineProperty.call(this, obj, prop, descriptor);
                            } catch (retryError) {
                                console.log('🔧 Ethereum retry failed - silently ignoring');
                                return; // Silently fail
                            }
                        }
                        throw error;
                    }
                };

                // Override defineProperties for multiple property definitions
                Object.defineProperties = function(obj, properties) {
                    if (obj === window && properties.ethereum) {
                        console.log('🔧 Ethereum in defineProperties - making configurable');
                        properties.ethereum = {
                            ...properties.ethereum,
                            configurable: true,
                            writable: true
                        };
                    }

                    try {
                        return originalDefineProperties.call(this, obj, properties);
                    } catch (error) {
                        if (properties.ethereum && error.message.includes('Cannot redefine property')) {
                            console.log('🔧 Ethereum defineProperties blocked - deleting and retrying');
                            try {
                                delete obj.ethereum;
                                return originalDefineProperties.call(this, obj, properties);
                            } catch (retryError) {
                                console.log('🔧 Ethereum defineProperties retry failed - silently ignoring');
                                return; // Silently fail
                            }
                        }
                        throw error;
                    }
                };

                console.log('✅ Ethereum property conflict prevention installed');
            } catch (e) {
                console.log('❌ Ethereum property conflict prevention failed:', e);
            }

            // COMPLETE chrome object destruction
            try {
                if (typeof chrome !== 'undefined') {
                    delete window.chrome;
                    Object.defineProperty(window, 'chrome', {
                        get: () => undefined,
                        set: () => {},
                        configurable: false,
                        enumerable: false
                    });
                }
            } catch (e) {}

            // ULTIMATE console override with multiple suppression patterns
            ['error', 'warn', 'log', 'info', 'debug', 'trace'].forEach(method => {
                try {
                    const original = console[method];
                    console[method] = function(...args) {
                        const message = args.join(' ');
                        const suppressPatterns = [
                            'Unchecked runtime.lastError',
                            'Could not establish connection',
                            'Receiving end does not exist',
                            'Extension context invalidated',
                            'chrome.runtime',
                            'chrome-extension://',
                            'inpage.js',
                            'content_script',
                            'extension',
                            'runtime.lastError',
                            'Cannot redefine property: ethereum',
                            'ethereum',
                            'MetaMask',
                            'wallet',
                            'defineProperty'
                        ];

                        if (suppressPatterns.some(pattern => message.includes(pattern))) {
                            return; // Completely suppress
                        }
                        original.apply(console, args);
                    };
                } catch (e) {}
            });

            // ULTIMATE error handler suppression
            const suppressError = (message) => {
                if (!message) return false;
                const suppressPatterns = [
                    'Unchecked runtime.lastError',
                    'Could not establish connection',
                    'Receiving end does not exist',
                    'Extension context invalidated',
                    'chrome.runtime',
                    'chrome-extension://',
                    'inpage.js',
                    'content_script',
                    'extension',
                    'runtime.lastError',
                    'Cannot redefine property: ethereum',
                    'ethereum',
                    'MetaMask',
                    'wallet',
                    'defineProperty',
                    'TypeError: Cannot redefine property'
                ];
                return suppressPatterns.some(pattern => message.includes(pattern));
            };

            window.onerror = function(message, source, lineno, colno, error) {
                // Aggressive ethereum error suppression
                if (message && (
                    message.includes('Cannot redefine property: ethereum') ||
                    message.includes('ethereum') ||
                    source && source.includes('inpage.js')
                )) {
                    console.log('🔇 Suppressed ethereum property error:', message);
                    return true; // Suppress completely
                }

                if (suppressError(message) || suppressError(source)) {
                    return true; // Suppress completely
                }
                return false;
            };

            window.addEventListener('error', function(e) {
                // Aggressive ethereum error suppression
                if (e.message && (
                    e.message.includes('Cannot redefine property: ethereum') ||
                    e.message.includes('ethereum') ||
                    e.filename && e.filename.includes('inpage.js')
                )) {
                    console.log('🔇 Suppressed ethereum property error event:', e.message);
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }

                if (suppressError(e.message) || suppressError(e.filename)) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);

            // Block ALL unhandled promise rejections from extensions
            window.addEventListener('unhandledrejection', function(e) {
                const reason = e.reason;
                const message = reason && reason.message ? reason.message : String(reason);
                if (suppressError(message)) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);

            // Block extension script injection
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.tagName === 'SCRIPT' && node.src && node.src.includes('chrome-extension://')) {
                            node.remove();
                        }
                    });
                });
            });

            if (document.body) {
                observer.observe(document.body, { childList: true, subtree: true });
            } else {
                document.addEventListener('DOMContentLoaded', function() {
                    observer.observe(document.body, { childList: true, subtree: true });
                });
            }
        })();
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; object-src 'none'; connect-src 'self' https: wss:;">
    <title>VibeVoyage - Smart Navigation</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="./icons/icon.svg">
    <link rel="apple-touch-icon" href="./icons/icon.svg">
    <meta name="theme-color" content="#00FF88">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VibeVoyage">
    <meta name="format-detection" content="telephone=no">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Leaflet JS for maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- JavaScript Services -->
    <script src="src/services/HazardDetectionService.js?v=2025.22&nocache=true&force=reload"></script>
    <script src="src/services/GeocodingService.js?v=2025.22&nocache=true&force=reload"></script>
    <script src="src/services/TrafficCameraService-Clean.js?v=2025.22&nocache=true&force=reload"></script>
    <script src="src/services/RoadObstacleService.js?v=2025.22&nocache=true&force=reload"></script>
    <script src="src/services/VoiceNavigationService.js?v=2025.22&nocache=true&force=reload"></script>
    <script src="src/services/WakeWordService.js?v=2025.22&nocache=true&force=reload"></script>
    <script src="src/services/VoiceHazardReportService.js?v=2025.22&nocache=true&force=reload"></script>

    <!-- Refactored Modular Architecture -->
    <!-- Core modules -->
    <script src="src/core/BaseModule.js"></script>
    <script src="src/core/ModuleLoader.js"></script>
    <script src="src/core/AppCore.js"></script>

    <!-- Application modules -->
    <script src="src/modules/SettingsManager.js"></script>
    <script src="src/modules/LanguageManager.js"></script>
    <script src="src/modules/MapManager.js"></script>
    <script src="src/modules/LocationManager.js"></script>
    <script src="src/modules/RouteManager.js"></script>
    <script src="src/modules/NavigationManager.js"></script>
    <script src="src/modules/UIManager.js"></script>
    <script src="src/modules/GamificationManager.js"></script>
    <script src="src/modules/HazardManager.js"></script>

    <!-- Main Application - Load App.js directly with aggressive cache busting -->
    <script>
        // Force load App.js with current timestamp to bypass all caching
        const appScript = document.createElement('script');
        appScript.src = 'App.js?v=1753822553776&t=' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true&nocache=true&force=reload&cachebuster=v3';
        appScript.defer = true;
        document.head.appendChild(appScript);
        console.log('🔧 Loading App.js with timestamp:', appScript.src);

        // Set a global flag to indicate app is loading
        window.vibeVoyageLoading = true;
    </script>

    <!-- Fallback for modular loading (if needed) -->
    <script>
        // Ensure App.js is loaded
        setTimeout(() => {
            if (typeof initializeVibeVoyage === 'undefined') {
                console.warn('⚠️ initializeVibeVoyage not found, loading App.js again');
                const script = document.createElement('script');
                script.src = 'App.js?v=1753822553776&t=' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true&nocache=true&force=reload';
                script.onload = () => {
                    console.log('✅ App.js loaded successfully');
                    if (typeof initializeVibeVoyage === 'function') {
                        initializeVibeVoyage();
                    }
                };
                document.head.appendChild(script);
            }
        }, 1000);
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #00FF88;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background: #00FF88;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #00CC66;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: #00FF88;
            color: #000;
            font-weight: bold;
            animation: testButtonPulse 2s ease-in-out infinite;
        }

        .btn-primary:hover {
            background: #00CC66;
            transform: translateY(-1px);
        }

        @keyframes testButtonPulse {
            0%, 100% {
                box-shadow: 0 0 5px #00FF88;
            }
            50% {
                box-shadow: 0 0 15px #00FF88, 0 0 25px #00FF88;
            }
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .btn-voice {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            color: white;
            border: 2px solid #FF6B6B;
        }

        .btn-voice:hover {
            background: linear-gradient(45deg, #FF5252, #FF7979);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        
        /* Journey Planning Section */
        .journey-planning-section {
            padding: 5px 15px 10px 15px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .planning-container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Route Hazards Section */
        .route-hazards-section {
            padding: 15px;
            background: rgba(255, 107, 107, 0.1);
            border-bottom: 1px solid #FF6B6B;
        }

        .hazards-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .hazards-list {
            margin: 10px 0;
        }

        .hazard-item {
            background: rgba(255, 107, 107, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #FF6B6B;
            font-size: 13px;
        }

        .hazards-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .hazards-actions .btn {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }
        
        .search-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: #333;
            border: 1px solid #555;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #00FF88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }
        
        .navigate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #00FF88 0%, #00CC66 100%);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
            min-height: 48px;
        }

        .mobile-navigate-btn {
            margin-top: 10px;
            padding: 16px;
            font-size: 17px;
            min-height: 52px;
        }
        
        .navigate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        
        .navigate-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Map Section */
        .map-section {
            flex: 1;
            position: relative;
            min-height: 450px;
            height: 450px;
            background: #1a1a1a;
            margin: 20px;
            padding: 20px;
        }

        .interactive-map {
            width: 100%;
            height: 100%;
            position: relative;
            background: #1a1a1a;
        }

        #map {
            width: 100%;
            height: 400px;
            min-height: 400px;
            background: #1a1a1a;
            position: relative;
            z-index: 1;
            border: 2px solid #00FF88;
            border-radius: 8px;
        }

        /* Map Overlay Controls */
        .map-overlay-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .map-control-btn {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 8px;
            color: #00FF88;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .map-control-btn:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00FF88;
            transform: scale(1.05);
        }

        .control-icon {
            font-size: 16px;
        }

        /* Route Markers and Vehicle */
        .vehicle-marker {
            background: none;
            border: none;
        }

        .vehicle-icon {
            font-size: 20px;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
            transition: transform 0.3s ease;
        }

        .route-marker {
            background: none;
            border: none;
        }

        .marker-icon {
            font-size: 18px;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
        }

        .hazard-marker {
            background: rgba(255, 107, 107, 0.9);
            border: 2px solid #FF6B6B;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hazard-marker.hazard-high {
            background: rgba(255, 0, 0, 0.9);
            border-color: #FF0000;
            animation: pulse-hazard 2s infinite;
        }

        .hazard-marker.hazard-medium {
            background: rgba(255, 165, 0, 0.9);
            border-color: #FFA500;
        }

        .hazard-marker.hazard-low {
            background: rgba(255, 255, 0, 0.9);
            border-color: #FFFF00;
        }

        .hazard-icon {
            font-size: 14px;
        }

        @keyframes pulse-hazard {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Hazard List Items */
        .hazard-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hazard-message {
            flex: 1;
            color: #fff;
        }

        .hazard-severity {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .severity-high {
            background: #FF0000;
            color: #fff;
        }

        .severity-medium {
            background: #FFA500;
            color: #000;
        }

        .severity-low {
            background: #FFFF00;
            color: #000;
        }

        /* Map Error State */
        .map-error {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
            text-align: center;
            padding: 20px;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .map-placeholder {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
            text-align: center;
            padding: 20px;
            background: #1a1a1a;
        }

        .map-placeholder .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .map-placeholder div {
            margin-bottom: 8px;
        }

        .map-placeholder small {
            opacity: 0.8;
            margin-bottom: 15px;
        }
        
        /* Quick Actions */
        .quick-actions {
            padding: 15px;
            background: #1a1a1a;
            border-top: 1px solid #333;
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            background: #333;
            border: 1px solid #555;
            border-radius: 12px;
            color: #fff;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .action-btn:hover {
            background: #444;
            border-color: #00FF88;
            transform: translateY(-2px);
        }
        
        .action-icon {
            font-size: 24px;
        }
        
        .action-text {
            font-size: 12px;
            text-align: center;
        }
        
        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: #000;
            border-top: 1px solid #333;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-online { color: #00FF88; }
        .status-offline { color: #FF6B6B; }
        .status-warning { color: #FFA500; }
        
        /* Navigation Panel */
        .nav-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #00FF88 0%, #00CC66 100%);
            color: #000;
            padding: 0;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .nav-panel.active {
            transform: translateY(0);
        }

        .nav-hazard-alert {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #FFC107;
            border-radius: 5px;
            padding: 5px 8px;
            margin-top: 5px;
            font-size: 12px;
            color: #FFC107;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-hazard-alert .hazard-icon {
            font-size: 14px;
        }

        /* Voice Log and Hazard Summary Panel */
        .nav-bottom-panel {
            background: rgba(0, 0, 0, 0.9);
            border-top: 1px solid #333;
            display: flex;
            height: 120px;
        }

        .voice-log, .hazard-summary-panel {
            flex: 1;
            padding: 10px;
            border-right: 1px solid #333;
        }

        .hazard-summary-panel {
            border-right: none;
        }

        .voice-log-header, .hazard-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: bold;
            color: #00FF88;
        }

        .voice-clear-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 10px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .voice-clear-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #999;
        }

        .voice-log-content, .hazard-summary-content {
            height: 80px;
            overflow-y: auto;
            font-size: 11px;
        }

        .voice-entry {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
            padding: 2px 0;
        }

        .voice-time {
            color: #666;
            min-width: 35px;
        }

        .voice-text {
            color: #ccc;
            flex: 1;
        }

        .hazard-summary-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            padding: 4px 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .hazard-summary-item:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        .hazard-summary-item .hazard-icon {
            font-size: 14px;
        }

        .hazard-summary-item .hazard-info {
            flex: 1;
        }

        .hazard-summary-item .hazard-name {
            display: block;
            font-weight: bold;
            font-size: 11px;
        }

        .hazard-summary-item .hazard-distance {
            display: block;
            color: #666;
            font-size: 10px;
        }

        .hazard-total {
            color: #FFC107;
            font-size: 11px;
        }

        /* Hazard Markers */
        @keyframes hazardPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        .hazard-marker {
            z-index: 1000;
        }

        .hazard-marker-content {
            transition: transform 0.2s ease;
        }

        /* Hazard Popup Styles */
        .hazard-popup {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-width: 200px;
        }

        .hazard-popup-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .hazard-popup-icon {
            font-size: 20px;
        }

        .hazard-popup-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .hazard-popup-content {
            margin-bottom: 15px;
        }

        .hazard-popup-content p {
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }

        .hazard-popup-actions {
            display: flex;
            gap: 8px;
        }

        .hazard-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hazard-btn.confirm {
            background: #28a745;
            color: white;
        }

        .hazard-btn.confirm:hover {
            background: #218838;
        }

        .hazard-btn.gone {
            background: #dc3545;
            color: white;
        }

        .hazard-btn.gone:hover {
            background: #c82333;
        }

        .hazard-popup-container .leaflet-popup-content-wrapper {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .hazard-popup-container .leaflet-popup-tip {
            background: white;
        }

        /* Off-Screen Indicator */
        .off-screen-indicator {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #00FF88;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1003;
            text-align: center;
            min-width: 120px;
            animation: offScreenPulse 2s ease-in-out infinite;
        }

        .off-screen-arrow {
            font-size: 24px;
            margin-bottom: 8px;
            color: #00FF88;
            animation: offScreenArrowBounce 1s ease-in-out infinite;
        }

        .off-screen-text {
            font-size: 12px;
            margin-bottom: 10px;
            color: #ccc;
        }

        .off-screen-recenter {
            background: #00FF88;
            color: #000;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .off-screen-recenter:hover {
            background: #00CC66;
            transform: scale(1.05);
        }

        @keyframes offScreenPulse {
            0%, 100% {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
            50% {
                opacity: 0.8;
                transform: translateY(-50%) scale(1.05);
            }
        }

        @keyframes offScreenArrowBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-3px);
            }
        }

        /* Position variants for off-screen indicator */
        .off-screen-indicator.top {
            top: 20px;
            right: 50%;
            transform: translateX(50%);
        }

        .off-screen-indicator.bottom {
            bottom: 20px;
            right: 50%;
            transform: translateX(50%);
        }

        .off-screen-indicator.left {
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .off-screen-indicator.right {
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Mobile-Friendly Input Layout */
        .mobile-input-container {
            margin-bottom: 15px;
        }

        .input-row {
            margin-bottom: 8px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .mobile-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #333;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-size: 14px;
            min-height: 44px; /* iOS touch target */
        }

        .mobile-input:focus {
            outline: none;
            border-color: #00FF88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }

        .search-btn {
            padding: 12px 16px !important;
            min-width: 44px;
            min-height: 44px;
            border-radius: 8px !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swap-row {
            display: flex;
            justify-content: center;
            margin: 5px 0;
        }

        .swap-btn-mobile {
            background: linear-gradient(135deg, #00FF88 0%, #00CC66 100%);
            color: #000;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3);
        }

        .swap-btn-mobile:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.5);
        }

        .swap-btn-mobile:active {
            transform: scale(0.95);
        }

        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 60px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #333;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            color: #fff;
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background: rgba(0, 255, 136, 0.1);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-main {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .suggestion-details {
            font-size: 12px;
            color: #ccc;
        }

        .suggestion-type {
            display: inline-block;
            background: rgba(0, 255, 136, 0.2);
            color: #00FF88;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 8px;
        }

        /* Mobile-Friendly Address Examples */
        .mobile-examples {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #333;
        }

        .examples-header {
            color: #00FF88;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 13px;
            text-align: center;
        }

        .examples-mobile {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .example-tag {
            background: rgba(0, 255, 136, 0.1);
            color: #00FF88;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            white-space: nowrap;
        }

        .examples-detail {
            margin-top: 10px;
        }

        .example-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            border-left: 3px solid #00FF88;
            margin-bottom: 5px;
        }

        .example-item strong {
            color: #00FF88;
        }

        .swap-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
        }

        .swap-btn-enhanced {
            border-radius: 50% !important;
            width: 50px !important;
            height: 50px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }

            .search-section {
                padding: 10px;
            }

            .quick-actions {
                padding: 10px;
            }

            /* Mobile Map Fixes */
            #map {
                width: 100% !important;
                height: 60vh !important;
                min-height: 300px !important;
                max-height: 70vh !important;
                position: relative !important;
                display: block !important;
                touch-action: manipulation !important;
            }

            .leaflet-container {
                width: 100% !important;
                height: 100% !important;
                touch-action: manipulation !important;
            }

            .mobile-input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 14px 16px;
            }

            .search-btn {
                padding: 14px 18px !important;
                min-width: 48px;
                min-height: 48px;
            }

            .swap-btn-mobile {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }

            .address-suggestions {
                right: 48px; /* Account for search button */
            }

            .suggestion-item {
                padding: 14px 16px;
                font-size: 14px;
            }

            .suggestion-main {
                font-size: 15px;
            }

            .examples-mobile {
                gap: 8px;
            }

            .example-tag {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        /* Settings Two-Column Layout */
        @media (min-width: 600px) {
            .settings-columns {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 599px) {
            .settings-columns {
                display: block;
            }

            .settings-column {
                margin-bottom: 20px;
            }
        }

        /* Touch-friendly buttons */
        @media (hover: none) and (pointer: coarse) {
            .btn, .nav-btn, .quick-action-btn {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 16px;
            }

            .mobile-input {
                font-size: 16px; /* Prevents zoom */
            }
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
        }

        .nav-instruction {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .nav-icon {
            font-size: 32px;
            min-width: 40px;
            text-align: center;
        }

        .nav-text {
            flex: 1;
        }

        .nav-distance {
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
            margin-bottom: 4px;
        }

        .nav-direction {
            font-size: 16px;
            opacity: 0.8;
            line-height: 1.2;
        }

        .nav-actions {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(0, 0, 0, 0.2);
            border: none;
            color: #000;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: rgba(0, 0, 0, 0.3);
            transform: scale(1.1);
        }

        .nav-btn.active {
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .nav-btn.follow-active {
            background: #00FF88;
            color: #000;
        }

        .nav-btn.recenter-pulse {
            animation: recenterPulse 0.5s ease-in-out;
        }

        @keyframes recenterPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .nav-progress {
            background: rgba(0, 0, 0, 0.1);
            padding: 10px 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #000;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .nav-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
        }

        /* Visual Lane Recognition System */
        .lane-visualization {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-top: 1px solid rgba(0, 255, 136, 0.3);
            padding: 15px 20px;
            color: #fff;
        }

        .lane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .lane-title {
            font-size: 14px;
            font-weight: bold;
            color: #00FF88;
        }

        .lane-instruction {
            font-size: 12px;
            color: #ccc;
        }

        /* Top-down Lane Display */
        .lane-display {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .lane-item {
            width: 35px;
            height: 60px;
            border: 2px solid #444;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 5px 2px;
            background: linear-gradient(180deg, #333 0%, #222 100%);
            position: relative;
            transition: all 0.3s ease;
        }

        .lane-item.valid {
            border-color: #00FF88;
            background: linear-gradient(180deg, #00FF88 0%, #00CC66 100%);
            color: #000;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            transform: scale(1.05);
        }

        .lane-item.recommended {
            border-color: #FFD700;
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            transform: scale(1.1);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .lane-arrow {
            font-size: 18px;
            font-weight: bold;
            line-height: 1;
        }

        .lane-number {
            font-size: 10px;
            font-weight: bold;
            opacity: 0.8;
        }

        /* 3D Road View */
        .lane-road-view {
            height: 80px;
            background: linear-gradient(180deg, #444 0%, #222 50%, #111 100%);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .road-surface {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, #333 0%, #111 100%);
            transform: perspective(100px) rotateX(45deg);
            transform-origin: bottom;
        }

        .road-lane {
            position: absolute;
            bottom: 0;
            height: 60px;
            border-left: 1px dashed #666;
            border-right: 1px dashed #666;
            transition: all 0.3s ease;
        }

        .road-lane.valid {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00FF88;
        }

        .road-lane.recommended {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
            animation: roadPulse 1.5s ease-in-out infinite;
        }

        .road-car {
            position: absolute;
            bottom: 10px;
            width: 20px;
            height: 30px;
            background: #00BFFF;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.5s ease;
            z-index: 10;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1.1);
                box-shadow: 0 0 15px rgba(0, 191, 255, 0.7);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 25px rgba(0, 191, 255, 0.9);
            }
        }

        @keyframes roadPulse {
            0%, 100% {
                background: rgba(255, 215, 0, 0.3);
            }
            50% {
                background: rgba(255, 215, 0, 0.5);
            }
        }

        /* Lane Direction Indicators */
        .lane-directions {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }

        .direction-indicator {
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid #444;
        }

        .direction-indicator.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00FF88;
            color: #00FF88;
        }

        /* Route Selection Panel */
        .route-selection-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            color: #fff;
            border-top: 2px solid #00FF88;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            max-height: 70vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .route-selection-panel.show {
            transform: translateY(0);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #333;
        }

        .route-header h3 {
            margin: 0;
            color: #00FF88;
            font-size: 18px;
        }

        .close-routes {
            background: none;
            border: none;
            color: #ccc;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-routes:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .route-options {
            padding: 10px 20px;
        }

        .route-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .route-option:hover {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(0, 255, 136, 0.3);
        }

        .route-option.selected {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00FF88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .route-option.fastest {
            border-left: 4px solid #00FF88;
        }

        .route-option.shortest {
            border-left: 4px solid #FFD700;
        }

        .route-option.scenic {
            border-left: 4px solid #87CEEB;
        }

        .route-option.eco {
            border-left: 4px solid #90EE90;
        }

        .route-info {
            flex: 1;
        }

        .route-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .route-name {
            font-weight: bold;
            font-size: 16px;
            color: #fff;
        }

        .route-badge {
            background: #00FF88;
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .route-badge.fastest {
            background: #00FF88;
        }

        .route-badge.shortest {
            background: #FFD700;
        }

        .route-badge.scenic {
            background: #87CEEB;
        }

        .route-badge.eco {
            background: #90EE90;
        }

        .route-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 5px;
        }

        .route-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .route-stat-icon {
            font-size: 16px;
        }

        .route-stat-value {
            font-weight: bold;
            color: #00FF88;
        }

        .route-details {
            font-size: 12px;
            color: #ccc;
            line-height: 1.3;
        }

        .route-actions {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-top: 1px solid #333;
        }

        .route-actions .btn {
            flex: 1;
            padding: 12px;
            text-align: center;
        }

        /* Route Visualization on Map */
        .route-line-1 {
            color: #00FF88 !important;
            weight: 6;
            opacity: 0.9;
        }

        .route-line-2 {
            color: #00CC66 !important;
            weight: 5;
            opacity: 0.7;
        }

        .route-line-3 {
            color: #00AA44 !important;
            weight: 5;
            opacity: 0.7;
        }

        .route-line-4 {
            color: #008833 !important;
            weight: 5;
            opacity: 0.7;
        }

        .route-line-selected {
            weight: 8 !important;
            opacity: 1 !important;
            animation: routeHighlight 2s ease-in-out infinite;
        }

        @keyframes routeHighlight {
            0%, 100% {
                opacity: 1;
                filter: drop-shadow(0 0 8px #00FF88);
            }
            50% {
                opacity: 0.7;
                filter: drop-shadow(0 0 12px #00FF88);
            }
        }

        /* Speedometer */
        .speedometer {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 2px solid #00FF88;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
            z-index: 1001;
            min-width: 120px;
        }

        .speedometer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .speed-display {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .current-speed {
            font-size: 36px;
            font-weight: bold;
            color: #00FF88;
            text-shadow: 0 0 10px #00FF88;
            line-height: 1;
        }

        .speed-unit {
            font-size: 14px;
            color: #ccc;
            margin-top: -5px;
        }

        .speed-limit-display {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .speed-limit-icon {
            width: 40px;
            height: 40px;
            background: #fff;
            border: 3px solid #ff0000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .speed-limit-value {
            font-size: 16px;
            font-weight: bold;
            color: #000;
        }

        .speed-status {
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 8px;
            text-align: center;
        }

        .speed-status.safe {
            background: rgba(0, 255, 136, 0.2);
            color: #00FF88;
        }

        .speed-status.warning {
            background: rgba(255, 165, 0, 0.2);
            color: #FFA500;
        }

        .speed-status.danger {
            background: rgba(255, 107, 107, 0.2);
            color: #FF6B6B;
            animation: speedWarning 1s ease-in-out infinite;
        }

        @keyframes speedWarning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Voice Reporting UI Styles */
        .voice-reporting-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .voice-reporting-content {
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid #00FF88;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            color: #00FF88;
            font-family: 'Orbitron', monospace;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }

        .mic-animation {
            margin-bottom: 20px;
        }

        .mic-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .mic-icon.pulsing {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .reporting-text {
            font-size: 18px;
            margin-bottom: 20px;
            color: #87CEEB;
        }

        .cancel-reporting-btn {
            background: #FF6B6B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: 'Orbitron', monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-reporting-btn:hover {
            background: #FF5252;
            transform: scale(1.05);
        }

        /* Wake Word Feedback */
        .wake-word-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 255, 136, 0.9);
            color: #000;
            padding: 20px 30px;
            border-radius: 15px;
            font-family: 'Orbitron', monospace;
            font-weight: bold;
            z-index: 2500;
            animation: wakeWordFeedback 3s ease-in-out;
        }

        .wake-word-animation {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .wake-word-text {
            font-size: 16px;
        }

        @keyframes wakeWordFeedback {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }

        /* User Hazard Marker Styles */
        .user-hazard-marker {
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hazard-icon {
            font-size: 24px;
            background: rgba(0, 255, 136, 0.9);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #00FF88;
        }

        .user-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #FFD700;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border: 1px solid #FFA500;
        }

        .hazard-popup.user-reported {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(135, 206, 235, 0.1));
            border: 1px solid #00FF88;
            border-radius: 10px;
            padding: 10px;
        }

        .hazard-popup.user-reported h4 {
            color: #00FF88;
            margin: 0 0 10px 0;
        }

        /* Journey Control Panel */
        .journey-control-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            color: #fff;
            border-top: 2px solid #00FF88;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1002;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .journey-control-panel.show {
            transform: translateY(0);
        }

        .journey-header {
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #333;
        }

        .journey-header h3 {
            margin: 0 0 10px 0;
            color: #00FF88;
            font-size: 18px;
        }

        .journey-route-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .journey-route-info .route-name {
            font-weight: bold;
            color: #fff;
        }

        .journey-route-info .route-stats {
            color: #ccc;
            font-size: 14px;
        }

        .journey-preview {
            padding: 15px 20px;
        }

        .hazard-summary {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .hazard-count {
            display: block;
            color: #FFC107;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .hazard-icons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .hazard-icon {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid #444;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hazard-icon:hover {
            background: rgba(0, 0, 0, 0.7);
            border-color: #666;
        }

        .hazard-icon.police {
            border-color: #FF6B6B;
            color: #FF6B6B;
        }

        .hazard-icon.camera {
            border-color: #FFA500;
            color: #FFA500;
        }

        .hazard-icon.roadwork {
            border-color: #FFD700;
            color: #FFD700;
        }

        .hazard-icon.traffic-light {
            border-color: #87CEEB;
            color: #87CEEB;
        }

        .journey-actions {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-top: 1px solid #333;
        }

        .journey-actions .btn {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        .journey-start-btn {
            background: linear-gradient(135deg, #00FF88 0%, #00CC66 100%);
            color: #000;
            font-size: 16px;
        }

        .journey-resume-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #fff;
            font-size: 16px;
        }

        .journey-start-btn:hover, .journey-resume-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        /* Responsive Design for Route Selection */
        @media (max-width: 768px) {
            .route-selection-panel {
                max-height: 80vh;
            }

            .route-option {
                padding: 12px;
            }

            .route-stats {
                gap: 15px;
            }

            .route-stat {
                font-size: 13px;
            }

            .journey-control-panel {
                border-radius: 15px 15px 0 0;
            }

            .journey-actions .btn {
                padding: 12px;
                font-size: 14px;
            }
        }

        /* Responsive Design for Lane Visualization */
        @media (max-width: 768px) {
            .lane-visualization {
                padding: 10px 15px;
            }

            .lane-item {
                width: 28px;
                height: 50px;
            }

            .lane-arrow {
                font-size: 14px;
            }

            .lane-road-view {
                height: 60px;
            }
        }

        /* Car marker animation */
        .car-marker {
            transition: all 0.5s ease;
        }

        /* Chevron vehicle animation */
        .chevron-vehicle {
            transition: all 0.3s ease;
        }

        @keyframes chevronBreathe {
            0%, 100% {
                filter: drop-shadow(0 0 6px #00BFFF) drop-shadow(0 2px 4px rgba(0,0,0,0.3));
                transform: scale(1);
                opacity: 0.9;
            }
            50% {
                filter: drop-shadow(0 0 12px #00BFFF) drop-shadow(0 0 8px #00BFFF) drop-shadow(0 2px 4px rgba(0,0,0,0.3));
                transform: scale(1.15);
                opacity: 1;
            }
        }

        /* Route line animation */
        .route-line {
            animation: routePulse 2s ease-in-out infinite;
        }

        @keyframes routePulse {
            0%, 100% {
                filter: drop-shadow(0 0 4px #00FF88);
            }
            50% {
                filter: drop-shadow(0 0 8px #00FF88) drop-shadow(0 0 12px #00FF88);
            }
        }

        @keyframes routePulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 0.7; }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }
            
            .search-section {
                padding: 15px;
            }
            
            .quick-actions {
                padding: 15px;
            }
            
            .actions-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
            
            .action-btn {
                padding: 12px 8px;
            }
            
            .action-text {
                font-size: 10px;
            }
        }
        
        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-radius: 50%;
            border-top-color: #00FF88;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a1a1a;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #00FF88;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            min-width: 200px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
            word-wrap: break-word;
        }
        
        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #00FF88;
            background: #0a2a1a;
        }

        .notification.error {
            border-left-color: #FF6B6B;
            background: #2a0a0a;
        }

        .notification.warning {
            border-left-color: #FFA500;
            background: #2a1a0a;
        }

        .notification.info {
            border-left-color: #4ECDC4;
            background: #0a1a2a;
        }

        /* Default location input styling */
        .search-input.default-location {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border: 2px solid #00FF88;
            color: #006644;
            font-style: italic;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
            transition: all 0.3s ease;
        }

        .search-input.default-location::placeholder {
            color: #008855;
            opacity: 0.7;
        }

        .search-input.default-location:focus {
            background: #ffffff;
            color: #333;
            font-style: normal;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
        }

        /* Transport Mode Selector */
        .transport-mode-selector {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transport-modes {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .transport-mode-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ccc;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 80px;
            justify-content: center;
        }

        .transport-mode-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: #fff;
            transform: translateY(-1px);
        }

        .transport-mode-btn.active {
            background: linear-gradient(135deg, #00FF88 0%, #00CC6A 100%);
            border-color: #00FF88;
            color: #000;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .transport-mode-btn.active:hover {
            background: linear-gradient(135deg, #00FF88 0%, #00DD77 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        /* Mode-specific styling */
        .transport-mode-btn[data-mode="driving"].active {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            border-color: #4ECDC4;
        }

        .transport-mode-btn[data-mode="cycling"].active {
            background: linear-gradient(135deg, #45B7D1 0%, #3A9BC1 100%);
            border-color: #45B7D1;
        }

        .transport-mode-btn[data-mode="walking"].active {
            background: linear-gradient(135deg, #96CEB4 0%, #85B8A3 100%);
            border-color: #96CEB4;
        }

        /* Connection Status Indicator */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10000;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .connection-status.online {
            background: linear-gradient(135deg, #00FF88 0%, #00CC6A 100%);
            color: #000;
            border: 1px solid #00FF88;
            font-weight: bold;
        }

        .connection-status.offline {
            background: linear-gradient(135deg, #FF6B6B 0%, #E55555 100%);
            color: #fff;
            border: 1px solid #FF6B6B;
            animation: pulse 2s infinite;
            font-weight: bold;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Offline Mode Styling */
        .offline-mode .search-input {
            border-color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
        }

        .offline-mode .transport-mode-btn {
            opacity: 0.7;
        }

        .offline-mode .navigate-btn {
            background: linear-gradient(135deg, #FF6B6B 0%, #E55555 100%);
        }

        /* Offline notification styling */
        .notification.offline {
            background: linear-gradient(135deg, #FF6B6B 0%, #E55555 100%);
            border-left-color: #FF6B6B;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span>🧭</span>
                <span>VibeVoyage</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" id="hazardSettingsBtn" onclick="toggleHazardSettings()" title="Hazard Avoidance Settings">🚨</button>
                <button class="btn btn-secondary" onclick="toggleSettings()" title="App Settings">⚙️</button>
                <button class="btn btn-secondary" onclick="showLanguageSelector()" title="Language / Idioma">🌍</button>
                <button class="btn btn-secondary" onclick="getCurrentLocation()" title="Get Current Location">📍</button>
                <button class="btn btn-secondary" onclick="shareCurrentRoute()" title="Share Current Route">📤</button>
                <button class="btn btn-secondary" onclick="toggleFavorites()" title="Favorite Locations">⭐</button>
                <button class="btn btn-secondary" onclick="showGamificationStats()" title="Stats & Achievements">🏆</button>
                <button class="btn btn-voice" onclick="toggleVoiceReporting()" title="Voice Hazard Reporting" id="voiceReportingBtn">🎙️</button>
            </div>
        </header>

        <!-- Favorites Panel (Hidden by default) -->
        <div id="favoritesContainer" style="display: none; position: fixed; top: 60px; left: 0; right: 0; z-index: 10000; background: rgba(0,0,0,0.9); padding: 20px; max-height: 80vh; overflow-y: auto;" onclick="if(event.target === this) this.style.display='none';">
            <div style="background: #1a1a1a; border-radius: 12px; padding: 20px; color: #fff; border: 1px solid #333; max-width: 500px; margin: 0 auto; position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #00FF88; margin: 0;">⭐ Favorite Locations</h3>
                    <button onclick="document.getElementById('favoritesContainer').style.display='none'" style="background: #FF6B6B; border: none; color: white; font-size: 18px; cursor: pointer; padding: 5px 10px; border-radius: 4px; font-weight: bold;">✕</button>
                </div>
                <div id="favoritesList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Favorites will be populated by JavaScript -->
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="clearAllFavorites()" style="background: #FF6B6B; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">Clear All Favorites</button>
                </div>
            </div>
        </div>

        <!-- Hazard Avoidance Panel (Hidden by default) -->
        <div id="hazardAvoidanceContainer" style="display: none; position: fixed; top: 60px; left: 0; right: 0; z-index: 10000; background: rgba(0,0,0,0.9); padding: 20px; max-height: 80vh; overflow-y: auto;" onclick="if(event.target === this) this.style.display='none';">
            <!-- Emergency close button -->
            <div style="position: absolute; top: 10px; right: 10px; z-index: 10001;">
                <button onclick="document.getElementById('hazardAvoidanceContainer').style.display='none'; event.stopPropagation();"
                        style="background: #FF4444; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px;">
                    ✕ CLOSE
                </button>
            </div>
        </div>

        <!-- Journey Planning Section - Moved to top of map -->
        <section class="journey-planning-section">
            <div class="planning-container">
                <div class="mobile-input-container">
                    <div class="input-row">
                        <div class="input-wrapper">
                            <input type="text" id="fromInput" class="search-input mobile-input"
                                   placeholder="From: Address, company, postcode..."
                                   onkeypress="handleFromSearchKeypress(event)"
                                   oninput="handleAddressInput('from', this.value)"
                                   title="Current location is used by default. Click to select all and type a different starting point.">
                            <button class="btn btn-secondary search-btn" onclick="searchFromLocation(document.getElementById('fromInput').value)">🔍</button>
                            <div class="address-suggestions" id="fromSuggestions"></div>
                        </div>
                    </div>

                    <div class="swap-row">
                        <button class="swap-btn-mobile" onclick="swapLocations()" title="Swap locations">⇅</button>
                    </div>

                    <div class="input-row">
                        <div class="input-wrapper">
                            <input type="text" id="toInput" class="search-input mobile-input"
                                   placeholder="To: Address, company, postcode..."
                                   onkeypress="handleToSearchKeypress(event)"
                                   oninput="handleAddressInput('to', this.value)">
                            <button class="btn btn-secondary search-btn" onclick="searchToLocation(document.getElementById('toInput').value)">🔍</button>
                            <div class="address-suggestions" id="toSuggestions"></div>
                        </div>
                    </div>
                </div>

                <!-- Transport Mode Selector -->
                <div class="transport-mode-selector" style="margin: 15px 0;">
                    <div style="text-align: center; margin-bottom: 8px; color: #ccc; font-size: 12px; font-weight: 500;">
                        Choose Transport Mode
                    </div>
                    <div class="transport-modes" style="display: flex; gap: 8px; justify-content: center;">
                        <button class="transport-mode-btn active" data-mode="driving" onclick="selectTransportMode('driving')"
                                title="Driving - Fastest routes via roads">
                            🚗 Drive
                        </button>
                        <button class="transport-mode-btn" data-mode="cycling" onclick="selectTransportMode('cycling')"
                                title="Cycling - Safe routes via cycle paths and quiet roads">
                            🚴 Cycle
                        </button>
                        <button class="transport-mode-btn" data-mode="walking" onclick="selectTransportMode('walking')"
                                title="Walking - Direct routes via footpaths and pedestrian areas">
                            🚶 Walk
                        </button>
                    </div>
                </div>

                <button class="navigate-btn mobile-navigate-btn" id="navigateBtn" onclick="startNavigation()" disabled>
                    <span id="navigateBtnIcon">🚗</span> <span id="navigateBtnText">Start Navigation</span>
                </button>

                <!-- Weather and ETA Display -->
                <div class="info-displays" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <div id="weatherDisplay" style="flex: 1; min-width: 200px;"></div>
                    <div id="etaDisplay" style="flex: 1; min-width: 200px;"></div>
                </div>

                <!-- Quick Service Finder -->
                <div class="service-finder" style="margin-top: 15px;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                        <button onclick="findNearbyParking()" style="background: #4ECDC4; color: black; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                            🅿️ Parking
                        </button>
                        <button onclick="findNearbyFuel()" style="background: #FF6B6B; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                            ⛽ Fuel
                        </button>
                        <button onclick="findNearbyRestaurants()" style="background: #45B7D1; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                            🍽️ Food
                        </button>
                        <button onclick="findNearbyHospitals()" style="background: #96CEB4; color: black; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                            🏥 Medical
                        </button>
                        <button onclick="compareRoutes()" style="background: #F7DC6F; color: black; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                            📊 Compare
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Map Section -->
        <section class="map-section">
            <div id="map" class="interactive-map">
                <!-- Map will be initialized here by Leaflet -->
                <div id="mapLoadingIndicator" style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: #00FF88;
                    font-size: 18px;
                    z-index: 1000;
                    text-align: center;
                ">
                    🗺️ Loading Map...<br>
                    <small style="color: #ccc;">Please wait while we initialize the interactive map</small>
                </div>
            </div>

            <!-- Map Overlay Controls -->
            <div class="map-overlay-controls">
                <button class="map-control-btn" id="recenterBtn" onclick="recenterMap()" title="Recenter map">
                    <span class="control-icon">🎯</span>
                </button>
                <button class="map-control-btn" id="zoomInBtn" onclick="zoomIn()" title="Zoom in">
                    <span class="control-icon">➕</span>
                </button>
                <button class="map-control-btn" id="zoomOutBtn" onclick="zoomOut()" title="Zoom out">
                    <span class="control-icon">➖</span>
                </button>
                <button class="map-control-btn" onclick="toggleMapType()" title="Toggle map type">
                    <span class="control-icon">🛰️</span>
                </button>
            </div>
        </section>

        <!-- Route Selection Panel (Hidden by default) -->
        <div id="routeSelectionPanel" class="route-selection-panel" style="display: none;">
            <div class="route-header">
                <h3>Choose Your Route</h3>
                <button class="close-routes" onclick="hideRouteSelection()">×</button>
            </div>
            <div class="route-options" id="routeOptions">
                <!-- Route options will be dynamically inserted here -->
            </div>
            <div class="route-actions">
                <button class="btn btn-secondary" onclick="hideRouteSelection()">Cancel</button>
                <button class="btn" onclick="selectRouteForJourney()" id="selectRouteBtn" disabled>Select Route</button>
            </div>
        </div>

        <!-- Speedometer -->
        <div id="speedometer" class="speedometer" style="display: none;">
            <div class="speedometer-container">
                <div class="speed-display">
                    <div class="current-speed" id="currentSpeed">0</div>
                    <div class="speed-unit">mph</div>
                </div>
                <div class="speed-limit-display">
                    <div class="speed-limit-icon">
                        <div class="speed-limit-value" id="speedLimit">30</div>
                    </div>
                </div>
                <div class="speed-status" id="speedStatus">SAFE</div>
            </div>
        </div>

        <!-- Journey Control Panel (Hidden by default) -->
        <div id="journeyControlPanel" class="journey-control-panel" style="display: none;">
            <div class="journey-header">
                <h3>Ready to Start Journey</h3>
                <div class="journey-route-info" id="journeyRouteInfo">
                    <span class="route-name">Fastest Route</span>
                    <span class="route-stats">12.5 km • 18 min</span>
                </div>
            </div>
            <div class="journey-preview" id="journeyPreview">
                <div class="hazard-summary">
                    <span class="hazard-count" id="hazardCount">3 hazards detected</span>
                    <div class="hazard-icons" id="hazardIcons">
                        <!-- Hazard icons will be inserted here -->
                    </div>
                </div>
            </div>
            <div class="journey-actions">
                <button class="btn btn-secondary" onclick="cancelJourney()">Cancel</button>
                <button class="btn btn-primary journey-start-btn" onclick="startJourney()" id="startJourneyBtn">
                    🚗 Start Journey
                </button>
                <button class="btn btn-success journey-resume-btn" onclick="resumeJourney()" id="resumeJourneyBtn" style="display: none;">
                    ▶️ Resume Journey
                </button>
            </div>
        </div>

        <!-- Navigation Panel (Hidden by default) -->
        <div id="navPanel" class="nav-panel">
            <div class="nav-content">
                <div class="nav-instruction">
                    <div class="nav-icon" id="navIcon">➡️</div>
                    <div class="nav-text">
                        <div class="nav-distance" id="navDistance">0.3 mi</div>
                        <div class="nav-direction" id="navDirection">Turn right onto Main Street</div>
                        <div class="nav-hazard-alert" id="navHazardAlert" style="display: none;">
                            <span class="hazard-icon">⚠️</span>
                            <span class="hazard-text">Speed camera in 200m</span>
                        </div>
                    </div>
                </div>
                <div class="nav-actions">
                    <button class="nav-btn" id="followModeBtn" onclick="toggleFollowMode()" title="Toggle Follow Mode">📍</button>
                    <button class="nav-btn" id="recenterBtn" onclick="recenterMap()" title="Re-center on Location">🎯</button>
                    <button class="nav-btn" onclick="toggleNavigationView()" title="Toggle View">🗺️</button>
                    <button class="nav-btn" onclick="testLaneGuidance()" title="Test Lane Guidance">🛣️</button>
                    <button class="nav-btn" onclick="pauseJourney()" title="Pause Journey" id="pauseJourneyBtn">⏸️</button>
                    <button class="nav-btn nav-stop" onclick="stopNavigation()" title="Stop Navigation">⏹️</button>
                </div>
            </div>

            <!-- Off-Screen Indicator -->
            <div id="offScreenIndicator" class="off-screen-indicator" style="display: none;">
                <div class="off-screen-arrow" id="offScreenArrow">↑</div>
                <div class="off-screen-text">You are here</div>
                <button class="off-screen-recenter" onclick="recenterMap()">Re-center</button>
            </div>
            </div>

            <!-- Voice Log and Hazard Summary -->
            <div class="nav-bottom-panel" id="navBottomPanel">
                <div class="voice-log" id="voiceLog">
                    <div class="voice-log-header">
                        <span>Voice Log</span>
                        <button class="voice-clear-btn" onclick="clearVoiceLog()">Clear</button>
                    </div>
                    <div class="voice-log-content" id="voiceLogContent">
                        <div class="voice-entry">
                            <span class="voice-time">12:34</span>
                            <span class="voice-text">Navigation started</span>
                        </div>
                    </div>
                </div>
                <div class="hazard-summary-panel" id="hazardSummaryPanel">
                    <div class="hazard-summary-header">
                        <span>Route Hazards</span>
                        <span class="hazard-total" id="hazardTotal">0 ahead</span>
                    </div>
                    <div class="hazard-summary-content" id="hazardSummaryContent">
                        <!-- Hazard summary items will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Visual Lane Recognition Display -->
            <div id="laneVisualization" class="lane-visualization" style="display: none;">
                <div class="lane-header">
                    <span class="lane-title">Lane Guidance</span>
                    <span class="lane-instruction" id="laneInstruction">Use right lanes</span>
                </div>
                <div class="lane-display" id="laneDisplay">
                    <!-- Dynamic lane visualization will be inserted here -->
                </div>
                <div class="lane-road-view" id="laneRoadView">
                    <!-- 3D-style road view will be inserted here -->
                </div>
            </div>

            <div class="nav-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="nav-stats">
                    <span id="navETA">ETA: --:--</span>
                    <span id="navRemaining">-- remaining</span>
                    <span id="navTotal">Total: --</span>
                </div>
            </div>
        </div>
        


        <!-- Route Hazards Section -->
        <section class="route-hazards-section" id="routeHazardsSection" style="display: none;">
            <div class="hazards-container">
                <h3 style="color: #FF6B6B; margin: 0 0 10px 0; font-size: 16px;">⚠️ Route Hazards Detected</h3>
                <div id="hazardsList" class="hazards-list"></div>
                <div class="hazards-actions">
                    <button class="btn btn-secondary" onclick="showAlternativeRoutes()">🔄 Find Alternative Routes</button>
                    <button class="btn btn-primary" onclick="proceedWithRoute()">✅ Continue Anyway</button>
                </div>
            </div>
        </section>
        


        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span>📍</span>
                <span id="locationStatus">Getting location...</span>
            </div>
            <div class="status-item">
                <span>🧭</span>
                <span id="compassStatus">Ready</span>
            </div>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notification" class="notification"></div>
    
    <!-- Leaflet JS is already loaded in the head section -->

    <script>
        // NUCLEAR OPTION: Immediate error suppression before anything else
        (function() {
            // Block all chrome.runtime access immediately
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    Object.defineProperty(chrome.runtime, 'lastError', {
                        get: function() { return undefined; },
                        set: function() {},
                        configurable: false,
                        enumerable: false
                    });
                } catch (e) {}

                try {
                    chrome.runtime.sendMessage = function() { return Promise.resolve(); };
                    chrome.runtime.connect = function() {
                        return {
                            postMessage: () => {},
                            disconnect: () => {},
                            onMessage: { addListener: () => {} },
                            onDisconnect: { addListener: () => {} }
                        };
                    };
                } catch (e) {}
            }

            // Block chrome object entirely if needed
            try {
                if (typeof chrome !== 'undefined') {
                    Object.defineProperty(window, 'chrome', {
                        get: function() { return undefined; },
                        set: function() {},
                        configurable: false
                    });
                }
            } catch (e) {}

            // Immediate console override with more aggressive suppression
            const suppress = (method) => {
                try {
                    const original = console[method];
                    console[method] = function(...args) {
                        const message = args.join(' ');
                        if (message.includes('Unchecked runtime.lastError') ||
                            message.includes('Could not establish connection') ||
                            message.includes('Receiving end does not exist') ||
                            message.includes('Extension context invalidated') ||
                            message.includes('chrome.runtime')) {
                            return;
                        }
                        original.apply(console, args);
                    };
                } catch (e) {}
            };

            ['error', 'warn', 'log', 'info', 'debug', 'trace'].forEach(suppress);

            // Override window.onerror immediately
            window.onerror = function(message, source, lineno, colno, error) {
                if (message && (message.includes('Unchecked runtime.lastError') ||
                               message.includes('Could not establish connection') ||
                               message.includes('Receiving end does not exist'))) {
                    return true; // Suppress completely
                }
                return false;
            };
        })();

        // AGGRESSIVE: Suppress browser extension runtime connection errors at all levels

        // Override window.onerror to catch browser-level errors
        window.onerror = function(message, source, lineno, colno, error) {
            if (message && (message.includes('Could not establish connection') ||
                           message.includes('Receiving end does not exist') ||
                           message.includes('Unchecked runtime.lastError') ||
                           message.includes('Extension context invalidated'))) {
                return true; // Suppress these errors completely
            }
            return false;
        };

        // Suppress at the error event level
        window.addEventListener('error', function(e) {
            if (e.message && (e.message.includes('Could not establish connection') ||
                             e.message.includes('Extension context invalidated') ||
                             e.message.includes('Receiving end does not exist') ||
                             e.message.includes('Unchecked runtime.lastError'))) {
                e.preventDefault();
                e.stopPropagation();
                return true;
            }
        }, true); // Use capture phase

        // Block chrome.runtime access entirely if it's causing issues
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            try {
                // Override chrome.runtime.sendMessage to prevent connection attempts
                const originalSendMessage = chrome.runtime.sendMessage;
                chrome.runtime.sendMessage = function(...args) {
                    // Silently ignore all extension message attempts
                    return new Promise((resolve) => resolve());
                };

                // Override chrome.runtime.connect to prevent connection attempts
                if (chrome.runtime.connect) {
                    chrome.runtime.connect = function(...args) {
                        // Return a mock port that does nothing
                        return {
                            postMessage: () => {},
                            disconnect: () => {},
                            onMessage: { addListener: () => {} },
                            onDisconnect: { addListener: () => {} }
                        };
                    };
                }
            } catch (e) {
                // Ignore any errors from overriding chrome.runtime
            }
        }

        // Suppress unhandled promise rejections for extension errors
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.message && (e.reason.message.includes('Could not establish connection') ||
                                                e.reason.message.includes('Extension context invalidated') ||
                                                e.reason.message.includes('Receiving end does not exist'))) {
                e.preventDefault();
                return true;
            }
        });

        // Comprehensive error suppression for browser extension errors
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('Could not establish connection') ||
                message.includes('Extension context invalidated') ||
                message.includes('Receiving end does not exist') ||
                message.includes('Unchecked runtime.lastError') ||
                message.includes('Location error') ||
                message.includes('GeolocationPositionError') ||
                message.includes('Location tracking error') ||
                message.includes('Invalid LatLng object: (NaN, NaN)')) {
                return; // Suppress these errors
            }
            originalConsoleError.apply(console, args);
        };

        // Suppress browser-level runtime errors
        const originalLog = console.log;
        console.log = function(...args) {
            const message = args.join(' ');
            if (message.includes('Unchecked runtime.lastError') ||
                message.includes('Could not establish connection')) {
                return; // Suppress these logs
            }
            originalLog.apply(console, args);
        };

        // Also suppress the specific runtime.lastError messages
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            const originalSendMessage = chrome.runtime.sendMessage;
            chrome.runtime.sendMessage = function(...args) {
                try {
                    return originalSendMessage.apply(this, args);
                } catch (error) {
                    // Silently ignore connection errors
                    return;
                }
            };
        }

        // Suppress browser runtime errors at the window level
        window.addEventListener('error', function(e) {
            if (e.message && (e.message.includes('Could not establish connection') ||
                             e.message.includes('Receiving end does not exist') ||
                             e.message.includes('Unchecked runtime.lastError'))) {
                e.preventDefault();
                e.stopPropagation();
                return true;
            }
        }, true);

        // Override console methods to filter runtime errors
        const originalConsoleWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('Could not establish connection') ||
                message.includes('Receiving end does not exist') ||
                message.includes('Unchecked runtime.lastError')) {
                return; // Suppress these warnings
            }
            originalConsoleWarn.apply(console, args);
        };

        // NUCLEAR OPTION: Override console.info and console.debug for extension messages
        const originalConsoleInfo = console.info;
        console.info = function(...args) {
            const message = args.join(' ');
            if (message.includes('Unchecked runtime.lastError') ||
                message.includes('Could not establish connection')) {
                return; // Suppress these info messages
            }
            originalConsoleInfo.apply(console, args);
        };

        const originalConsoleDebug = console.debug;
        console.debug = function(...args) {
            const message = args.join(' ');
            if (message.includes('Unchecked runtime.lastError') ||
                message.includes('Could not establish connection')) {
                return; // Suppress these debug messages
            }
            originalConsoleDebug.apply(console, args);
        };

        // Override console.trace for extension traces
        const originalConsoleTrace = console.trace;
        console.trace = function(...args) {
            const message = args.join(' ');
            if (message.includes('Unchecked runtime.lastError') ||
                message.includes('Could not establish connection')) {
                return; // Suppress these traces
            }
            originalConsoleTrace.apply(console, args);
        };
    </script>

    <script>
        // CRITICAL: Global functions for button clicks - MUST be available immediately
        function toggleHazardSettings() {
            console.log('🚨 Hazard button clicked');
            if (window.app && typeof window.app.toggleHazardSettings === 'function') {
                window.app.toggleHazardSettings();
            } else {
                console.error('❌ App not ready - toggleHazardSettings');
                console.log('window.app:', window.app);
                alert('App is still loading. Please wait a moment and try again.');
            }
        }

        function toggleSettings() {
            console.log('⚙️ Settings button clicked');
            if (window.app && typeof window.app.toggleSettings === 'function') {
                window.app.toggleSettings();
            } else {
                console.error('❌ App not ready - toggleSettings');
                console.log('window.app:', window.app);
                alert('App is still loading. Please wait a moment and try again.');
            }
        }



        function showLanguageSelector() {
            console.log('🌍 Language selector clicked');
            if (window.app && typeof window.app.showLanguageSelector === 'function') {
                window.app.showLanguageSelector();
            } else {
                console.error('❌ App not ready - showLanguageSelector');
                alert('App is still loading. Please wait a moment and try again.');
            }
        }

        function toggleVoiceReporting() {
            console.log('🎙️ Voice reporting clicked');
            if (window.app && typeof window.app.toggleVoiceReporting === 'function') {
                window.app.toggleVoiceReporting();
            } else {
                console.error('❌ App not ready - toggleVoiceReporting');
                alert('App is still loading. Please wait a moment and try again.');
            }
        }

        function showGamificationStats() {
            console.log('🏆 Gamification stats clicked');
            if (window.app && typeof window.app.showGamificationStats === 'function') {
                window.app.showGamificationStats();
            } else {
                console.error('❌ App not ready - showGamificationStats');
                alert('App is still loading. Please wait a moment and try again.');
            }
        }

        // Debug function to check app status
        function checkAppStatus() {
            console.log('🔍 App Status Check:');
            console.log('window.app exists:', !!window.app);
            console.log('window.app type:', typeof window.app);
            if (window.app) {
                console.log('Available methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.app)));
            }
            console.log('VibeVoyageApp class:', typeof VibeVoyageApp);
            console.log('initializeVibeVoyage function:', typeof initializeVibeVoyage);
        }

        // Force app initialization function
        function forceInitializeApp() {
            console.log('🔧 Force initializing app...');
            if (typeof VibeVoyageApp !== 'undefined') {
                try {
                    window.app = new VibeVoyageApp();
                    console.log('✅ Force initialization successful!');
                    if (window.app.showNotification) {
                        window.app.showNotification('🔧 App force-initialized!', 'success');
                    }
                } catch (error) {
                    console.error('❌ Force initialization failed:', error);
                }
            } else {
                console.error('❌ VibeVoyageApp class not available');
            }
        }



        // Global functions that work with the main App.js


        function recenterMap() {
            console.log('🎯 Recenter map button clicked');
            if (window.app && window.app.recenterMap) {
                window.app.recenterMap();
            } else {
                console.log('App not ready for recenter');
            }
        }

        function zoomIn() {
            console.log('➕ Zoom in button clicked');
            if (window.app && window.app.zoomIn) {
                window.app.zoomIn();
            } else {
                console.log('App not ready for zoom in');
            }
        }

        function zoomOut() {
            console.log('➖ Zoom out button clicked');
            if (window.app && window.app.zoomOut) {
                window.app.zoomOut();
            } else {
                console.log('App not ready for zoom out');
            }
        }



        function getCurrentLocation() {
            if (window.app && window.app.getCurrentLocation) {
                window.app.getCurrentLocation();
            } else {
                console.log('Get current location - app not ready');
            }
        }

        async function testHazardDetection() {
            console.log('🧪 Testing hazard detection...');
            if (window.app && window.app.loadHazardsDirectly) {
                try {
                    const hazards = await window.app.loadHazardsDirectly();
                    console.log(`🧪 Test result: ${hazards.length} hazards loaded`);
                    if (hazards.length > 0) {
                        console.log('🧪 Sample hazard:', hazards[0]);
                        window.app.showNotification(`✅ Hazard detection working: ${hazards.length} hazards loaded`, 'success');
                    } else {
                        window.app.showNotification('⚠️ No hazards loaded - check hazards.geojson file', 'warning');
                    }
                } catch (error) {
                    console.error('🧪 Hazard loading test failed:', error);
                    window.app.showNotification('❌ Hazard detection failed', 'error');
                }
            } else {
                console.log('App not ready for hazard testing');
            }
        }

        function testAllFeatures() {
            console.log('🧪 Testing all new features...');

            if (!window.app) {
                console.error('❌ App not initialized');
                return;
            }

            // Test app state
            console.log('🔍 App state check:');
            console.log('- Map initialized:', !!window.app.map);
            console.log('- Current location:', window.app.currentLocation);
            console.log('- HazardDetectionService:', !!window.app.hazardDetectionService);
            console.log('- GeocodingService:', !!window.app.geocodingService);
            console.log('- VoiceNavigationService:', !!window.app.voiceNavigationService);

            // Test chevron vehicle
            console.log('🛸 Testing chevron vehicle...');
            if (window.app.currentLocation) {
                window.app.updateCarPosition(
                    window.app.currentLocation.lat,
                    window.app.currentLocation.lng,
                    45
                );
                console.log('✅ Chevron vehicle updated');
            }

            // Test speedometer
            console.log('📊 Testing speedometer...');
            const speedometer = document.getElementById('speedometer');
            if (speedometer) {
                speedometer.style.display = 'block';
                document.getElementById('currentSpeed').textContent = '35';
                document.getElementById('speedLimit').textContent = '30';
                document.getElementById('speedStatus').textContent = 'SPEEDING';
                document.getElementById('speedStatus').className = 'speed-status danger';
                console.log('✅ Speedometer displayed');
            }

            // Test address search
            console.log('🔍 Testing address search...');
            const toInput = document.getElementById('toInput');
            if (toInput) {
                toInput.value = 'london';
                toInput.dispatchEvent(new Event('input'));
                console.log('✅ Address search triggered');
            }

            window.app.showNotification('🧪 All features tested! Check console for details.', 'success');
        }

        function debugAppState() {
            console.log('🔧 Debug App State:');
            if (window.app) {
                console.log('✅ App object exists');
                console.log('- Map:', window.app.map ? '✅ Initialized' : '❌ Not initialized');
                console.log('- Map Ready:', window.app.map && window.app.map._loaded ? '✅ Ready' : '⚠️ Not ready');
                console.log('- Current Location:', window.app.currentLocation || '❌ Not set');
                console.log('- Location Request In Progress:', window.app.locationRequestInProgress ? '⚠️ Yes' : '✅ No');
                console.log('- Destination:', window.app.destination || '❌ Not set');
                console.log('- Map Layers:');
                console.log('  - markersLayer:', window.app.markersLayer ? '✅' : '❌');
                console.log('  - routeLayer:', window.app.routeLayer ? '✅' : '❌');
                console.log('  - hazardsLayer:', window.app.hazardsLayer ? '✅' : '❌');
                console.log('  - vehicleLayer:', window.app.vehicleLayer ? '✅' : '❌');
                console.log('- Services:');
                console.log('  - HazardDetectionService:', window.app.hazardDetectionService ? '✅' : '❌');
                console.log('  - GeocodingService:', window.app.geocodingService ? '✅' : '❌');
                console.log('  - VoiceNavigationService:', window.app.voiceNavigationService ? '✅' : '❌');

                if (window.app.showNotification) {
                    window.app.showNotification('🔧 Debug info logged to console', 'info');
                }
            } else {
                console.error('❌ App object not found');
            }
        }

        async function testRouteCalculation() {
            console.log('🛣️ Testing route calculation...');

            if (!window.app) {
                console.error('❌ App not initialized');
                return;
            }

            if (!window.app.currentLocation) {
                console.error('❌ No current location set');
                window.app.showNotification('❌ Please get your location first', 'error');
                return;
            }

            // Set a test destination
            const testDestination = {
                lat: window.app.currentLocation.lat + 0.01,
                lng: window.app.currentLocation.lng + 0.01
            };

            window.app.destination = testDestination;
            console.log('🎯 Test destination set:', testDestination);

            try {
                console.log('🔄 Starting route calculation test...');
                await window.app.calculateRoute();
                console.log('✅ Route calculation completed successfully');
                window.app.showNotification('✅ Route calculation test passed!', 'success');
            } catch (error) {
                console.error('❌ Route calculation failed:', error);
                window.app.showNotification(`❌ Route calculation failed: ${error.message}`, 'error');
            }
        }

        async function comprehensiveAppTest() {
            console.log('🔍 Starting comprehensive app test...');

            const results = {
                passed: 0,
                failed: 0,
                tests: []
            };

            function testResult(name, passed, details = '') {
                results.tests.push({ name, passed, details });
                if (passed) {
                    results.passed++;
                    console.log(`✅ ${name}: PASSED ${details}`);
                } else {
                    results.failed++;
                    console.error(`❌ ${name}: FAILED ${details}`);
                }
            }

            // Test 1: App Initialization
            testResult('App Initialization', !!window.app, window.app ? 'App object exists' : 'App object missing');

            // Test 2: JavaScript Services
            if (window.app) {
                testResult('HazardDetectionService', !!window.app.hazardDetectionService,
                    window.app.hazardDetectionService ? 'Service initialized' : 'Service missing');
                testResult('GeocodingService', !!window.app.geocodingService,
                    window.app.geocodingService ? 'Service initialized' : 'Service missing');
                testResult('VoiceNavigationService', !!window.app.voiceNavigationService,
                    window.app.voiceNavigationService ? 'Service initialized' : 'Service missing');
            }

            // Test 3: Map Initialization
            testResult('Map Initialization', !!(window.app && window.app.map),
                window.app && window.app.map ? 'Leaflet map initialized' : 'Map not initialized');

            // Test 4: Location Services
            testResult('Current Location', !!(window.app && window.app.currentLocation),
                window.app && window.app.currentLocation ? `Location: ${window.app.currentLocation.lat}, ${window.app.currentLocation.lng}` : 'No location');

            // Test 5: Hazard Detection
            if (window.app && window.app.hazardDetectionService) {
                try {
                    const hazards = await window.app.loadHazardsDirectly();
                    testResult('Hazard Loading', hazards.length > 0, `${hazards.length} hazards loaded`);
                } catch (error) {
                    testResult('Hazard Loading', false, `Error: ${error.message}`);
                }
            }

            // Test 6: UI Elements
            const speedometer = document.getElementById('speedometer');
            testResult('Speedometer Element', !!speedometer, speedometer ? 'Element exists' : 'Element missing');

            const testButton = document.querySelector('button[onclick="testHazardDetection()"]');
            testResult('Test Button', !!testButton, testButton ? 'Test button exists' : 'Test button missing');

            // Test 7: Service Worker
            testResult('Service Worker', 'serviceWorker' in navigator,
                'serviceWorker' in navigator ? 'Service Worker supported' : 'Service Worker not supported');

            // Test 8: Voice Services
            testResult('Speech Synthesis', 'speechSynthesis' in window,
                'speechSynthesis' in window ? 'Speech synthesis available' : 'Speech synthesis not available');

            // Test 9: Geolocation
            testResult('Geolocation API', 'geolocation' in navigator,
                'geolocation' in navigator ? 'Geolocation API available' : 'Geolocation API not available');

            // Test 10: Local Storage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                testResult('Local Storage', true, 'Local storage working');
            } catch (error) {
                testResult('Local Storage', false, `Error: ${error.message}`);
            }

            // Display results
            console.log('\n📊 TEST RESULTS:');
            console.log(`✅ Passed: ${results.passed}`);
            console.log(`❌ Failed: ${results.failed}`);
            console.log(`📈 Success Rate: ${((results.passed / (results.passed + results.failed)) * 100).toFixed(1)}%`);

            if (window.app) {
                const message = `Tests: ${results.passed}✅ ${results.failed}❌ (${((results.passed / (results.passed + results.failed)) * 100).toFixed(1)}% success)`;
                window.app.showNotification(message, results.failed === 0 ? 'success' : 'warning');
            }

            return results;
        }

        // Voice Hazard Reporting Functions
        function toggleVoiceReporting() {
            console.log('🎙️ Toggling voice hazard reporting...');

            if (!window.app) {
                console.error('❌ App not initialized');
                return;
            }

            const btn = document.getElementById('voiceReportingBtn');

            if (window.app.wakeWordService) {
                const status = window.app.wakeWordService.getStatus();

                if (status.isEnabled) {
                    // Stop wake word detection
                    window.app.wakeWordService.stop();
                    btn.textContent = '🎙️';
                    btn.title = 'Start Voice Hazard Reporting';
                    window.app.showNotification('Voice hazard reporting disabled', 'info');
                } else {
                    // Start wake word detection
                    const started = window.app.wakeWordService.start();
                    if (started) {
                        btn.textContent = '🔴';
                        btn.title = 'Stop Voice Hazard Reporting';
                        window.app.showNotification('Voice hazard reporting enabled - Say "Hey NavBuddy" or "Report hazard"', 'success');
                    } else {
                        window.app.showNotification('Voice hazard reporting not supported in this browser', 'error');
                    }
                }
            } else {
                console.error('❌ Wake word service not available');
                window.app.showNotification('Voice services not available', 'error');
            }
        }

        function testVoiceHazardReporting() {
            console.log('🎙️ Testing voice hazard reporting...');

            if (!window.app) {
                console.error('❌ App not initialized');
                return;
            }

            if (!window.app.voiceHazardReportService) {
                console.error('❌ Voice hazard report service not available');
                window.app.showNotification('Voice hazard reporting not available', 'error');
                return;
            }

            // Simulate wake word detection
            window.app.handleWakeWordDetected({
                wakeWord: 'test command',
                transcript: 'test command',
                confidence: 1.0,
                timestamp: Date.now()
            });
        }

        function showVoiceReportingStatus() {
            console.log('🎙️ Voice hazard reporting status:');

            if (!window.app) {
                console.error('❌ App not initialized');
                return;
            }

            if (window.app.wakeWordService) {
                const status = window.app.wakeWordService.getStatus();
                console.log('- Wake Word Service:', status);

                const message = `
                    Wake Word Detection: ${status.isEnabled ? '✅ Enabled' : '❌ Disabled'}
                    Browser Support: ${status.isSupported ? '✅ Supported' : '❌ Not Supported'}
                    Currently Listening: ${status.isListening ? '✅ Yes' : '❌ No'}
                    Wake Words: ${status.wakeWords.join(', ')}
                    Safari/iOS: ${status.isSafariOrIOS ? '⚠️ Yes (limited support)' : '✅ No'}
                `;

                window.app.showNotification(message, 'info');
            }

            if (window.app.voiceHazardReportService) {
                const isActive = window.app.voiceHazardReportService.isReportingActive();
                const currentStep = window.app.voiceHazardReportService.getCurrentStep();
                const supportedTypes = window.app.voiceHazardReportService.getSupportedHazardTypes();

                console.log('- Voice Hazard Report Service:');
                console.log('  - Active:', isActive);
                console.log('  - Current Step:', currentStep);
                console.log('  - Supported Types:', supportedTypes);
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🌟 DOM loaded, initializing VibeVoyage...');

            // Prevent double initialization
            if (window.app) {
                console.log('🔄 App already initialized, skipping...');
                return;
            }

            // Wait a bit for App.js to load
            setTimeout(() => {
                console.log('🔍 Checking for initializeVibeVoyage function...');
                console.log('typeof initializeVibeVoyage:', typeof initializeVibeVoyage);
                console.log('window.initializeVibeVoyage:', typeof window.initializeVibeVoyage);

                if (typeof initializeVibeVoyage === 'function') {
                    console.log('✅ Calling initializeVibeVoyage...');
                    initializeVibeVoyage();
                } else if (typeof window.initializeVibeVoyage === 'function') {
                    console.log('✅ Calling window.initializeVibeVoyage...');
                    window.initializeVibeVoyage();

                    // Hide map loading indicator after app loads
                    setTimeout(() => {
                        const mapIndicator = document.getElementById('mapLoadingIndicator');
                        if (mapIndicator) {
                            mapIndicator.style.display = 'none';
                        }
                    }, 3000);

                } else {
                    console.error('❌ initializeVibeVoyage function not found');
                    console.log('Available functions:', Object.getOwnPropertyNames(window).filter(name => name.includes('Vibe')));

                    // Try manual initialization
                    setTimeout(() => {
                        console.log('🔧 Attempting manual initialization...');
                        console.log('typeof VibeVoyageApp:', typeof VibeVoyageApp);
                        console.log('window.VibeVoyageApp:', typeof window.VibeVoyageApp);

                        if (typeof VibeVoyageApp !== 'undefined' && !window.app) {
                            try {
                                console.log('🔧 Creating VibeVoyageApp instance...');
                                window.app = new VibeVoyageApp();
                                console.log('✅ Manual initialization successful!');



                            } catch (error) {
                                console.error('❌ Manual initialization failed:', error);
                            }

                        } else if (!window.app) {
                            console.error('❌ VibeVoyageApp class not found');
                            console.log('Trying to load App.js again...');

                            // Try loading App.js again
                            const script = document.createElement('script');
                            script.src = 'App.js?v=1753822553776&t=' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true' + Date.now() + '&fixed=true&nocache=true&force=reload';
                            script.onload = () => {
                                console.log('✅ App.js reloaded');
                                setTimeout(() => {
                                    if (typeof VibeVoyageApp !== 'undefined') {
                                        window.app = new VibeVoyageApp();
                                        console.log('✅ App created after reload');
                                    }
                                }, 500);
                            };
                            document.head.appendChild(script);
                        }
                    }, 1000);
                }
            }, 500);
        });

        // Additional fallback - try to initialize after 5 seconds
        setTimeout(() => {
            if (!window.app) {
                console.log('🔄 Final fallback - trying to initialize app after 5 seconds...');
                if (typeof VibeVoyageApp !== 'undefined') {
                    try {
                        window.app = new VibeVoyageApp();
                        console.log('✅ App initialized via final fallback');
                    } catch (error) {
                        console.error('❌ Final fallback failed:', error);
                    }
                } else {
                    console.error('❌ VibeVoyageApp class still not available after 5 seconds');
                }
            }
        }, 5000);

        // Fallback basic map initialization
        function initBasicMap() {
            console.log('🗺️ Initializing basic fallback map...');

            try {
                if (typeof L !== 'undefined') {
                    const mapElement = document.getElementById('map');
                    if (mapElement) {
                        const map = L.map('map').setView([51.505, -0.09], 13);

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors'
                        }).addTo(map);

                        // Add futuristic vehicle marker
                        const futuristicIcon = L.divIcon({
                            html: `
                                <div style="
                                    width: 0;
                                    height: 0;
                                    border-left: 12px solid transparent;
                                    border-right: 12px solid transparent;
                                    border-bottom: 24px solid #00BFFF;
                                    filter: drop-shadow(0 0 8px #00BFFF);
                                    animation: pulse 2s ease-in-out infinite;
                                "></div>
                            `,
                            iconSize: [30, 30],
                            iconAnchor: [15, 20]
                        });

                        L.marker([51.505, -0.09], { icon: futuristicIcon })
                            .addTo(map)
                            .bindPopup('🛸 Futuristic Vehicle (Fallback Mode)');

                        console.log('✅ Basic map initialized successfully');
                    }
                } else {
                    console.error('❌ Leaflet not available for fallback map');
                }
            } catch (error) {
                console.error('❌ Fallback map initialization failed:', error);
            }
        }
    </script>

    <!-- FINAL NUCLEAR OPTION: Wrap everything in try-catch -->
    <script>
        try {
            // Additional ethereum error suppression
            setInterval(() => {
                try {
                    // Clear any ethereum-related errors from console
                    if (console.clear && Math.random() < 0.01) { // 1% chance to clear console
                        const errors = document.querySelectorAll('.console-error-level');
                        errors.forEach(error => {
                            if (error.textContent && error.textContent.includes('ethereum')) {
                                error.remove();
                            }
                        });
                    }
                } catch (e) {
                    // Silently ignore
                }
            }, 1000);

            console.log('🔇 Final ethereum error suppression layer active');
        } catch (e) {
            // Even this can fail silently
        }
    </script>
</body>
</html>
